<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <title>Deferred Demo</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        font-size: 16px;
        font-family: Verdana;
      }
      div {
        margin-top: 1em;
        margin-bottom: .3em;
      }
      .btn {
        font-size: 1em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h4>Ladies and Gentleman, yet another <a href="http://codepen.io/GeekTrainer/pen/16615d9fc58286d779fb6433ceb16113" target="_blank">CodePen demo</a> lifted/swiped/taken/copied from Christopher Harrison.</h4>
      <h4>Thanks Christopher!</h4>
      <div>
        &nbsp;
      </div>
      <h4>The <code>jQuery.Deferred()</code> factory creates a new <code>deferred</code> object.</h4>
      <h4>It is probably best for you to just look this one up in the jQuery docs <a href="https://api.jquery.com/category/deferred-object/" target="_blank">here</a> and <a href="https://api.jquery.com/jQuery.Deferred/" target="_blank">then here</a>.</h4>
      <div>
        <button type="button" class="btn btn-primary" id="start-worker">Start Worker</button>
      </div>
      <h4>Pressing the button will start a process that takes three seconds to complete. A message is displayed when <code>deferred.promise()</code> is used to return a promise object.</h4>
      <div>
        <ul id="messages"></ul>
      </div>
    </div>

    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>

    <script>
      $(function() {
        $('#start-worker').click(function() {
          // get promise
          var promise = beginProcessing();
          // register our event handlers
          promise.progress(function(message) {
            // update the UI to display progress
            $('#messages').append('<li>Progress: ' + message + '</li>');
          }).done(function(message) {
            // update the UI to display completion
            $('#messages').append('<li>Completion: ' + message + '</li>');
          });
        });
      })

      function beginProcessing() {
        // Create deferred object and make sure it's going to be in scope
        var deferred = new $.Deferred();
        // Call the code that creates the worker
        var worker = new Worker('js/demoDeferred.js');
        // register the message event handler
        worker.addEventListener('message', function(event) {
          // if the worker is ready it will send a message of 'READY'
          if (event.data === 'READY') {
            // No UI code -- don't make me refer to separation of concerns on you
            // progress notification
            deferred.notify('Worker Started');
          } else if (event.data === 'COMPLETED') {
            // processing is done
            // no UI code
            // completion notification
            deferred.resolve("Worker Completed");
            worker.terminate();
          }
        });
        return deferred.promise();
      }
    </script>
  </body>
</html>
